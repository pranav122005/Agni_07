#include <WiFi.h>
#include <WiFiUdp.h>
#include <ArduinoJson.h>
#include <WebServer.h>

/* ================= WiFi Credentials ================= */
const char* ssid = "Aditya";
const char* password = "12345678";

/* ================= UDP Config ================= */
WiFiUDP udp;
const unsigned int localPort = 5005;
char incomingPacket[1024];

/* ================= Forwarding Config ================= */
const char* NEXT_HOP_IP = "192.168.137.158";   // ðŸ”´ Laptop 2 IP
const unsigned int FORWARD_PORT = 5005;

/* ================= Web Server ================= */
WebServer server(80);

/* ================= Latest Emergency Data ================= */
String vehicleID = "N/A";
String issueData = "No Emergency";
String rawDescription = "-";
String latitudeData = "-";
String longitudeData = "-";
String hopTraceData = "-";

/* ================= SETUP ================= */
void setup() {

  Serial.begin(115200);
  delay(2000);

  Serial.println("Starting RSU...");

  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nConnected!");
  Serial.print("ESP32 IP Address: ");
  Serial.println(WiFi.localIP());

  udp.begin(localPort);
  Serial.println("UDP Server Started");

  server.on("/", handleRoot);
  server.begin();
  Serial.println("Web Server Started");
}

/* ================= LOOP ================= */
void loop() {
  handleUDP();
  server.handleClient();
}

/* ================= UDP RECEIVE ================= */
void handleUDP() {

  int packetSize = udp.parsePacket();

  if (packetSize) {

    int len = udp.read(incomingPacket, 1024);

    if (len > 0)
      incomingPacket[len] = 0;

    Serial.println("\n===== PACKET RECEIVED =====");
    Serial.println(incomingPacket);

    parsePacket(incomingPacket);
  }
}

/* ================= JSON PARSE + FORWARD ================= */
void parsePacket(char* packet) {

  StaticJsonDocument<1024> doc;
  DeserializationError error = deserializeJson(doc, packet);

  if (error) {
    Serial.println("JSON Parse Failed!");
    return;
  }

  // Append RSU as hop
  doc["hop_trace"].add("RSU");

  vehicleID = String((const char*)doc["vehicle_id"]);
  issueData = String((const char*)doc["issue"]);
  rawDescription = String((const char*)doc["raw_description"]);
  latitudeData = String(doc["latitude"].as<float>(), 6);
  longitudeData = String(doc["longitude"].as<float>(), 6);

  // Build hop trace string
  JsonArray hops = doc["hop_trace"];
  hopTraceData = "";

  for (JsonVariant v : hops) {
    hopTraceData += String((const char*)v) + " â†’ ";
  }

  Serial.println("Emergency Updated Successfully!");

  // Forward packet to next hop
  String forwardMessage;
  serializeJson(doc, forwardMessage);

  udp.beginPacket(NEXT_HOP_IP, FORWARD_PORT);
  udp.print(forwardMessage);
  udp.endPacket();

  Serial.println("Packet forwarded to HOP_1");
}

/* ================= WEB DASHBOARD ================= */
void handleRoot() {

  String html = "<html><head>";
  html += "<title>RSU Dashboard</title>";
  html += "<meta http-equiv='refresh' content='3'>";
  html += "</head><body style='font-family:Arial;'>";

  html += "<h1 style='color:red;'>ðŸš¨ Roadside Assistance Dashboard</h1>";

  html += "<p><b>Vehicle ID:</b> " + vehicleID + "</p>";
  html += "<p><b>Issue:</b> " + issueData + "</p>";
  html += "<p><b>Raw Description:</b> " + rawDescription + "</p>";
  html += "<p><b>Latitude:</b> " + latitudeData + "</p>";
  html += "<p><b>Longitude:</b> " + longitudeData + "</p>";
  html += "<p><b>Hop Path:</b> " + hopTraceData + "</p>";

  html += "</body></html>";

  server.send(200, "text/html", html);
}
